pipeline {
  agent {
    label "built-in"
  }

  stages {
    stage('Run Terraform build') {
      agent {
        ecs {
          inheritFrom "terraform"
          taskrole "arn:aws:iam::${env.MANAGEMENT_ACCOUNT}:role/TDRJenkinsAppTaskRoleMgmt"
        }
      }
      environment {
        TF_VAR_tdr_account_number = "${env.SANDBOX_ACCOUNT}"
        TF_CLI_ARGS = "-no-color"
      }
      stages {
        stage('Set up Terraform workspace') {
          steps {
            dir("terraform") {
              sh "git clone --branch changes-for-performance-checks https://github.com/nationalarchives/tdr-terraform-modules.git"
              sh "git clone --branch changes-for-performance-checks https://github.com/nationalarchives/tdr-terraform-environments.git"
              sh "terraform init"
              sh "terraform workspace new sbox || true"
              sh "terraform workspace select sbox"
              retry(5) {
                sh "terraform apply --auto-approve"
              }
            }
          }
        }
      }
    }
    stage('Run report') {
      steps {
        sh "checks -cr project"
        publishHTML (target: [
            keepAll: true,
            reportFiles: 'output.html',
            reportName: "Performance Checks Report"
        ])
      }
    }
  }
}